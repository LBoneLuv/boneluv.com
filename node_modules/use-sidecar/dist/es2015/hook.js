import { useState, useEffect } from 'react';
import { env } from './env';
var cache = new WeakMap();
export function useSidecar(importer, effect) {
    var options = effect && effect.options || {};
    if (env.isNode && !options.ssr) {
        return [null, null];
    }
    var couldUseCache = env.forceCache || (env.isNode && !!options.ssr) || (!options.async);
    var _a = useState(couldUseCache ? function () { return cache.get(importer); } : undefined), Car = _a[0], setCar = _a[1];
    var _b = useState(null), error = _b[0], setError = _b[1];
    useEffect(function () {
        if (!Car) {
            importer()
                .then(function (car) {
                var resolved = effect ? effect.read() : (car.default || car);
                if (!resolved) {
                    console.error('Sidecar error: with importer', importer);
                    if (effect) {
                        throw new Error('Sidecar medium not found');
                    }
                    else {
                        throw new Error('Sidecar not found in exports');
                    }
                }
                cache.set(importer, resolved);
                setCar(function () { return resolved; });
            }, function (e) { return setError(function () { return e; }); });
        }
    }, []);
    return [Car, error];
}
;
